<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Editor</title>
  <style>
    :root{
      --bg:#0b0f17;
      --card:#111827;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:rgba(255,255,255,.10);
      --radius:16px;
      --shadow:0 18px 50px rgba(0,0,0,.35);
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(96,165,250,.10), transparent 60%),
        radial-gradient(900px 700px at 90% 20%, rgba(245,158,11,.10), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px 14px 34px}
    .topbar{display:flex;gap:12px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:20px}
    .sub{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.4}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
      text-decoration:none;
      display:inline-flex;gap:8px;align-items:center;
    }
    .btn:hover{background:rgba(255,255,255,.06); transform: translateY(-1px);}
    .btn:active{transform: translateY(0px);}
    .btn.ok{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.08)}
    .btn.warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.08)}
    .btn.bad{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.08)}
    .hint{color:var(--muted);font-size:12px;margin-top:10px}

    .card{
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      margin-top:14px;
    }

    .tableWrap{overflow:auto}
    table{width:100%;border-collapse:collapse;min-width:1100px}
    thead th{
      text-align:left;font-size:12px;color:var(--muted);
      padding:12px;border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.03);
      position:sticky;top:0;backdrop-filter: blur(8px);
      white-space:nowrap;
    }
    tbody td{
      padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:top;
    }
    tbody tr:hover{background:rgba(255,255,255,.03)}
    input[type="text"], textarea{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      color:var(--text);
      border-radius:10px;
      padding:8px 10px;
      outline:none;
      font-size:12px;
    }
    textarea{min-height:44px;resize:vertical}
    .chk{transform:scale(1.1)}
    .act{display:flex;gap:8px;align-items:center}
    .miniBtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:7px 10px;border-radius:10px;
      cursor:pointer;
      font-size:12px;
    }
    .miniBtn:hover{background:rgba(255,255,255,.05)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      background:rgba(255,255,255,.03);
      color:var(--muted);
    }
    .fileRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .file{
      border:1px dashed rgba(255,255,255,.18);
      padding:10px 12px;border-radius:12px;
      color:var(--muted);
      font-size:12px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <h1>Dashboard Editor (Excel-like)</h1>
      <div class="sub">
        Loads <b>config.json</b> automatically â€¢ Edit rows â€¢ Import CSV/XLSX â€¢ Export config.json<br>
        <span class="pill">Workflow: Export â†’ replace config.json in VS Code â†’ commit/push</span>
      </div>
    </div>
    <div class="row">
      <a class="btn" href="./index.html">ðŸ“Š Open Dashboard</a>
      <button class="btn ok" id="addRow">ï¼‹ Add Row</button>
      <button class="btn warn" id="exportJson">â¬‡ Export config.json</button>
      <button class="btn" id="exportCsv">â¬‡ Export CSV</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="padding:12px 12px 0">
      <div class="fileRow">
        <label class="file">
          Import CSV
          <input type="file" id="csvFile" accept=".csv,text/csv" style="display:block;margin-top:8px" />
        </label>
        <label class="file">
          Import Excel (.xlsx)
          <input type="file" id="xlsxFile" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display:block;margin-top:8px" />
        </label>
        <span class="hint">
          Expected headers: <code>session,pair,chartTF,bestWindowParis,istWindow,golden,tightRules,comments,journal</code>
        </span>
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:160px">Session</th>
            <th style="width:190px">Pair</th>
            <th style="width:140px">Chart TF</th>
            <th style="width:190px">Best Window (Paris)</th>
            <th style="width:190px">IST Window</th>
            <th style="width:90px">Golden?</th>
            <th style="width:240px">Tight Rules</th>
            <th style="width:220px">Comments</th>
            <th style="width:260px">Journal URL</th>
            <th style="width:160px">Action</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- SheetJS (Excel import) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<script>
  const CFG_URL = "./config.json?x=" + Date.now();
  const state = { rows: [] };

  function normRow(r){
    return {
      session: r.session ?? "",
      pair: r.pair ?? "",
      chartTF: r.chartTF ?? r.chartTimeFrame ?? "",
      bestWindowParis: r.bestWindowParis ?? r.bestCTE ?? "",
      istWindow: r.istWindow ?? "",
      golden: (r.golden === true || r.golden === 1 || String(r.golden).toLowerCase() === "true"),
      tightRules: r.tightRules ?? "",
      comments: r.comments ?? "",
      journal: r.journal ?? ""
    };
  }

  async function load(){
    const res = await fetch(CFG_URL);
    const json = await res.json();
    const rows = (json.rows || []).map(normRow);
    state.rows = rows;
    render();
  }

  function render(){
    const tb = document.getElementById("tbody");
    tb.innerHTML = state.rows.map((r, i) => `
      <tr>
        <td><input type="text" value="${esc(r.session)}" data-k="session" data-i="${i}"></td>
        <td><input type="text" value="${esc(r.pair)}" data-k="pair" data-i="${i}"></td>
        <td><input type="text" value="${esc(r.chartTF)}" data-k="chartTF" data-i="${i}"></td>
        <td><input type="text" value="${esc(r.bestWindowParis)}" data-k="bestWindowParis" data-i="${i}"></td>
        <td><input type="text" value="${esc(r.istWindow)}" data-k="istWindow" data-i="${i}"></td>
        <td style="text-align:center">
          <input class="chk" type="checkbox" ${r.golden ? "checked" : ""} data-k="golden" data-i="${i}">
        </td>
        <td><textarea data-k="tightRules" data-i="${i}">${esc(r.tightRules)}</textarea></td>
        <td><textarea data-k="comments" data-i="${i}">${esc(r.comments)}</textarea></td>
        <td><input type="text" value="${esc(r.journal)}" data-k="journal" data-i="${i}" placeholder="https://..."></td>
        <td>
          <div class="act">
            <button class="miniBtn" data-act="dup" data-i="${i}">Duplicate</button>
            <button class="miniBtn" data-act="del" data-i="${i}" style="border-color:rgba(239,68,68,.35)">Delete</button>
          </div>
        </td>
      </tr>
    `).join("");
  }

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  // Update state on input
  document.addEventListener("input", (e)=>{
    const el = e.target;
    const i = el.getAttribute("data-i");
    const k = el.getAttribute("data-k");
    if(i === null || k === null) return;
    const idx = Number(i);
    if(k === "golden") state.rows[idx][k] = el.checked;
    else state.rows[idx][k] = el.value;
  });

  document.addEventListener("click", (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-act");
    if(!act) return;
    const idx = Number(el.getAttribute("data-i"));
    if(act === "del"){
      state.rows.splice(idx,1);
      render();
    }
    if(act === "dup"){
      state.rows.splice(idx+1,0,{...state.rows[idx]});
      render();
    }
  });

  document.getElementById("addRow").addEventListener("click", ()=>{
    state.rows.unshift(normRow({}));
    render();
  });

  function download(filename, text){
    const blob = new Blob([text], { type: "application/octet-stream" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  }

  document.getElementById("exportJson").addEventListener("click", ()=>{
    const cfg = { rows: state.rows.map(normRow) };
    download("config.json", JSON.stringify(cfg, null, 2));
  });

  document.getElementById("exportCsv").addEventListener("click", ()=>{
    const header = ["session","pair","chartTF","bestWindowParis","istWindow","golden","tightRules","comments","journal"];
    const lines = [header.join(",")];
    for(const r of state.rows){
      const row = [
        r.session, r.pair, r.chartTF, r.bestWindowParis, r.istWindow,
        r.golden ? "TRUE" : "FALSE",
        r.tightRules, r.comments, r.journal
      ].map(csvCell);
      lines.push(row.join(","));
    }
    download("config.csv", lines.join("\n"));
  });

  function csvCell(v){
    const s = String(v ?? "");
    if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
    return s;
  }

  // CSV import
  document.getElementById("csvFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    const text = await f.text();
    const rows = parseCSV(text);
    applyImportedRows(rows);
    e.target.value = "";
  });

  function parseCSV(text){
    // Simple CSV parser (handles quoted fields)
    const lines = text.replace(/\r/g,"").split("\n").filter(l=>l.trim()!=="");
    if(lines.length === 0) return [];
    const header = splitCSVLine(lines[0]).map(h=>h.trim());
    const out = [];
    for(let i=1;i<lines.length;i++){
      const cols = splitCSVLine(lines[i]);
      const obj = {};
      header.forEach((h, idx)=> obj[h] = cols[idx] ?? "");
      out.push(obj);
    }
    return out;
  }

  function splitCSVLine(line){
    const res = [];
    let cur = "", inQ=false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(ch === '"' ){
        if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
        else inQ = !inQ;
      } else if(ch === "," && !inQ){
        res.push(cur); cur = "";
      } else {
        cur += ch;
      }
    }
    res.push(cur);
    return res;
  }

  // XLSX import
  document.getElementById("xlsxFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    const data = await f.arrayBuffer();
    const wb = XLSX.read(data, { type: "array" });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, { defval:"" });
    applyImportedRows(json);
    e.target.value = "";
  });

  function applyImportedRows(imported){
    // Accept headers: session,pair,chartTF,bestWindowParis,istWindow,golden,tightRules,comments,journal
    const rows = imported.map(r => normRow({
      session: r.session ?? r.Session ?? "",
      pair: r.pair ?? r.Pair ?? r["Currency Pair"] ?? "",
      chartTF: r.chartTF ?? r.ChartTF ?? r["Chart time Frame"] ?? "",
      bestWindowParis: r.bestWindowParis ?? r["Best Window (Paris)"] ?? r["Best CTE +1 timeframe"] ?? "",
      istWindow: r.istWindow ?? r["IST Window"] ?? r["IST time Zone GMT+5:30"] ?? "",
      golden: r.golden ?? r.Golden ?? r["Golden?"] ?? false,
      tightRules: r.tightRules ?? r["Tight Rules"] ?? "",
      comments: r.comments ?? r.Comments ?? "",
      journal: r.journal ?? r.Journal ?? r["Journal URL"] ?? ""
    }));
    // Replace all rows (clean import). If you want merge instead, tell me.
    state.rows = rows;
    render();
  }

  load();
</script>
</body>
</html>
