<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Editor</title>
  <style>
    :root{
      --radius: 18px;
      --shadow: 0 18px 55px rgba(0,0,0,.35);
      --line: rgba(255,255,255,.10);
      --maxw: 1280px;
      --gap: 12px;
    }

    html[data-theme="midnight"]{
      --bg0:#070a11; --bg1:#0b1220;
      --card: rgba(255,255,255,.055);
      --card2: rgba(255,255,255,.035);
      --text:#e5e7eb; --muted:#9ca3af;
      --accent:#60a5fa; --ok:#22c55e; --warn:#f59e0b;
    }
    html[data-theme="slate"]{
      --bg0:#0b1020; --bg1:#0e1629;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.04);
      --text:#eef2ff; --muted:#aab2c5;
      --accent:#38bdf8; --ok:#34d399; --warn:#fbbf24;
    }

    /* Accent-forward palettes (keep same glass format; only palette shifts) */
    html[data-theme="ocean"]{
      --bg0:#06101a; --bg1:#081c2c;
      --card: rgba(255,255,255,.055);
      --card2: rgba(255,255,255,.035);
      --text:#e6f3ff; --muted:#a6c2d8;
      --accent:#38bdf8; --ok:#22c55e; --warn:#f59e0b;
    }
    html[data-theme="emerald"]{
      --bg0:#06120c; --bg1:#081f16;
      --card: rgba(255,255,255,.055);
      --card2: rgba(255,255,255,.035);
      --text:#e7fff3; --muted:#a8d7be;
      --accent:#34d399; --ok:#22c55e; --warn:#f59e0b;
    }
    html[data-theme="royal"]{
      --bg0:#0a0818; --bg1:#120b2a;
      --card: rgba(255,255,255,.055);
      --card2: rgba(255,255,255,.035);
      --text:#f0ecff; --muted:#c1b6e3;
      --accent:#a78bfa; --ok:#22c55e; --warn:#f59e0b;
    }
    html[data-theme="ruby"]{
      --bg0:#16070b; --bg1:#240a12;
      --card: rgba(255,255,255,.055);
      --card2: rgba(255,255,255,.035);
      --text:#ffe7ef; --muted:#e2a9b9;
      --accent:#fb7185; --ok:#22c55e; --warn:#f59e0b;
    }
    html[data-theme="light"]{
      --bg0:#f7f7fb; --bg1:#ffffff;
      --card: rgba(17,24,39,.06);
      --card2: rgba(17,24,39,.04);
      --line: rgba(17,24,39,.12);
      --text:#0b1220; --muted:#374151;
      --accent:#2563eb; --ok:#16a34a; --warn:#d97706;
      --shadow: 0 18px 55px rgba(0,0,0,.12);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 16% -10%, color-mix(in srgb, var(--accent) 20%, transparent), transparent 60%),
        radial-gradient(900px 650px at 90% 10%, color-mix(in srgb, var(--warn) 18%, transparent), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    .wrap{max-width:var(--maxw);margin:0 auto;padding:16px 12px 34px}
    .topbar{display:flex;gap:12px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.25}

    .glass{
      border:1px solid var(--line);
      background: linear-gradient(180deg, var(--card), var(--card2));
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
    }

    .btn{
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 60%, transparent);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;gap:8px;align-items:center;
      transition: transform .12s ease, background .12s ease;
      font-weight:700;
    }
    .btn:hover{background: color-mix(in srgb, var(--card) 80%, transparent); transform: translateY(-1px);}
    .btn:active{transform: translateY(0px);}
    .btn.warn{border-color: color-mix(in srgb, var(--warn) 50%, transparent);}
    .btn.ok{border-color: color-mix(in srgb, var(--ok) 50%, transparent);}

    .ctrls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .select{
      appearance:none;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 60%, transparent);
      color:var(--text);
      padding:10px 36px 10px 12px;
      border-radius:14px;
      outline:none;
      cursor:pointer;
      font-weight:700;
    }
    .selectWrap{position:relative}
    .selectWrap:after{
      content:"‚ñæ";
      position:absolute;right:12px;top:50%;
      transform:translateY(-50%);
      color:var(--muted);pointer-events:none;
      font-size:12px;
    }

    .hint{
      margin-top:12px;
      padding:12px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    code{background:rgba(255,255,255,.06); padding:2px 6px; border-radius:8px}

    .tableWrap{margin-top:12px; overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0; min-width:1100px}
    thead th{
      text-align:left;
      font-size:12px;
      padding:12px;
      color:var(--muted);
      background: color-mix(in srgb, var(--card) 65%, transparent);
      border-bottom:1px solid var(--line);
      position:sticky; top:0;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      white-space:nowrap;
    }
    tbody td{
      padding:10px 12px;
      border-bottom:1px solid color-mix(in srgb, var(--line) 60%, transparent);
      vertical-align:top;
      font-size:13px;
    }
    tbody tr:hover{background: color-mix(in srgb, var(--card) 40%, transparent)}
    tbody tr:last-child td{border-bottom:none}

    .cell{
      width:100%;
      border:1px solid color-mix(in srgb, var(--line) 80%, transparent);
      background: color-mix(in srgb, var(--card) 45%, transparent);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      outline:none;
      font-size:13px;
    }
    .cell.small{min-width:140px}
    .cell.long{min-width:240px}
    .cell.area{min-height:70px; resize:vertical}
    .actions{display:flex;gap:8px;justify-content:flex-end}
    .miniBtn{
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 55%, transparent);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
    }
    .miniBtn.danger{border-color: color-mix(in srgb, var(--warn) 50%, transparent);}

    .footerRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .muted{color:var(--muted)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Dashboard Editor (Excel-like)</h1>
        <div class="subtitle">Edits happen locally in your browser. Export <code>config.json</code> and upload to GitHub to publish.</div>
      </div>

      <div class="ctrls">
        <div class="selectWrap" title="Theme">
          <select class="select" id="themeSel">
            <option value="midnight">Midnight</option>
            <option value="slate">Slate</option>
            <option value="ocean">Ocean Blue</option>
            <option value="emerald">Emerald Green</option>
            <option value="royal">Royal Purple</option>
            <option value="ruby">Ruby Red</option>
            <option value="light">Light</option>
          </select>
        </div>

        <a class="btn" href="./index.html">‚Üê Open Dashboard</a>
      </div>
    </div>

    <div class="hint glass">
      <div><b>CSV import:</b> You can import from Excel by exporting CSV.</div>
      <div class="muted">Expected header:
        <code>session,pair,chartTF,bestWindowParis,istWindow,golden,tightRules,comments,journal</code>
        (golden can be TRUE/FALSE or 1/0)
      </div>
      <div class="muted" style="margin-top:8px">
        <b>Notes:</b> use a separate <code>notes.json</code> file (cleaner config). We'll wire it into the dashboard next.
      </div>
    </div>

    <div class="footerRow">
      <button class="btn ok" id="addRow">Ôºã Add Row</button>
      <button class="btn" id="saveBrowser">Save (Browser)</button>
      <button class="btn" id="clearBrowser">Clear (Browser)</button>
      <button class="btn" id="importCsv">Import CSV</button>
      <button class="btn" id="exportCfg">Export config.json</button>
    </div>

    <div class="tableWrap glass">
      <table>
        <thead>
          <tr>
            <th style="width:160px">Session</th>
            <th style="width:220px">Pair</th>
            <th style="width:140px">Chart TF</th>
            <th style="width:210px">Best Window (Paris)</th>
            <th style="width:210px">IST Window</th>
            <th style="width:90px">Golden?</th>
            <th style="width:260px">Tight Rules</th>
            <th style="width:240px">Comments</th>
            <th style="width:260px">Journal link</th>
            <th style="width:120px">Action</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="footerRow">
      <span class="muted" id="status">‚Äî</span>
    </div>
  </div>

<script>
  const THEME_KEY = "tsd_theme_v1";
  const BROWSER_KEY = "tsd_config_v2";

  let CFG = { schemaVersion: 2, defaultTheme: "midnight", rows: [] };

  function applyTheme(theme){
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem(THEME_KEY, theme);
  }
  function initTheme(defaultTheme){
    const saved = localStorage.getItem(THEME_KEY);
    const theme = saved || defaultTheme || "midnight";
    applyTheme(theme);
    document.getElementById("themeSel").value = theme;
  }

  function normalizeRow(r){
    return {
      session: r.session ?? "",
      pair: r.pair ?? "",
      chartTF: r.chartTF ?? "",
      bestWindowParis: r.bestWindowParis ?? "",
      istWindow: r.istWindow ?? "",
      golden: !!r.golden,
      tightRules: r.tightRules ?? "",
      comments: r.comments ?? "",
      journal: r.journal ?? ""
    };
  }

  async function loadFromRepo(){
    const res = await fetch("./config.json?x=" + Date.now());
    const json = await res.json();
    json.rows = (json.rows || []).map(normalizeRow);
    return json;
  }

  function loadFromBrowser(){
    const raw = localStorage.getItem(BROWSER_KEY);
    if(!raw) return null;
    try{
      const json = JSON.parse(raw);
      json.rows = (json.rows || []).map(normalizeRow);
      return json;
    }catch(e){
      return null;
    }
  }

  function saveToBrowser(){
    localStorage.setItem(BROWSER_KEY, JSON.stringify(CFG, null, 2));
    setStatus("Saved to browser storage ‚úÖ");
  }

  function clearBrowser(){
    localStorage.removeItem(BROWSER_KEY);
    setStatus("Browser storage cleared üßπ");
  }

  function setStatus(msg){
    document.getElementById("status").textContent = msg;
  }

  function tdInput(value, cls="cell"){
    return `<input class="${cls}" value="${escapeHtml(String(value||""))}">`;
  }
  function tdArea(value){
    return `<textarea class="cell area">${escapeHtml(String(value||""))}</textarea>`;
  }
  function tdCheckbox(checked){
    return `<input type="checkbox" ${checked ? "checked" : ""} />`;
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function render(){
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";
    CFG.rows.forEach((r, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${tdInput(r.session,"cell small")}</td>
        <td>${tdInput(r.pair,"cell small")}</td>
        <td>${tdInput(r.chartTF,"cell small")}</td>
        <td>${tdInput(r.bestWindowParis,"cell")}</td>
        <td>${tdInput(r.istWindow,"cell")}</td>
        <td style="text-align:center">${tdCheckbox(r.golden)}</td>
        <td>${tdArea(r.tightRules)}</td>
        <td>${tdArea(r.comments)}</td>
        <td>${tdInput(r.journal,"cell long")}</td>
        <td>
          <div class="actions">
            <button class="miniBtn danger" data-del="${idx}">Delete</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
    setStatus(`Loaded ${CFG.rows.length} rows`);
  }

  function readTableToCFG(){
    const rows = [];
    const tbody = document.getElementById("tbody");
    for(const tr of tbody.querySelectorAll("tr")){
      const tds = tr.querySelectorAll("td");
      rows.push({
        session: tds[0].querySelector("input").value.trim(),
        pair: tds[1].querySelector("input").value.trim(),
        chartTF: tds[2].querySelector("input").value.trim(),
        bestWindowParis: tds[3].querySelector("input").value.trim(),
        istWindow: tds[4].querySelector("input").value.trim(),
        golden: tds[5].querySelector("input[type=checkbox]").checked,
        tightRules: tds[6].querySelector("textarea").value,
        comments: tds[7].querySelector("textarea").value,
        journal: tds[8].querySelector("input").value.trim()
      });
    }
    CFG.rows = rows.map(normalizeRow);
  }

  function downloadJSON(filename, obj){
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function parseCsv(text){
    // Minimal CSV parser (handles quotes) - enough for Excel export.
    const rows = [];
    let cur = [], val = "", inQ = false;
    for(let i=0;i<text.length;i++){
      const ch = text[i];
      const next = text[i+1];
      if(inQ){
        if(ch === '"' && next === '"'){ val += '"'; i++; }
        else if(ch === '"'){ inQ = false; }
        else val += ch;
      }else{
        if(ch === '"') inQ = true;
        else if(ch === ','){ cur.push(val); val=""; }
        else if(ch === '\n'){ cur.push(val); rows.push(cur); cur=[]; val=""; }
        else if(ch === '\r'){ /* ignore */ }
        else val += ch;
      }
    }
    if(val.length || cur.length) { cur.push(val); rows.push(cur); }
    return rows;
  }

  function toBool(x){
    const s = String(x||"").trim().toLowerCase();
    return (s === "true" || s === "1" || s === "yes" || s === "y");
  }

  async function importCSV(){
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".csv,text/csv";
    input.onchange = async () => {
      if(!input.files?.length) return;
      const file = input.files[0];
      const text = await file.text();
      const parsed = parseCsv(text);
      if(!parsed.length) return;

      const header = parsed[0].map(h=>h.trim());
      const idx = (name) => header.indexOf(name);

      if(idx("session") === -1 || idx("pair") === -1){
        alert("CSV header must include at least: session,pair,...");
        return;
      }

      const out = [];
      for(const row of parsed.slice(1)){
        if(!row.join("").trim()) continue;
        out.push(normalizeRow({
          session: row[idx("session")] ?? "",
          pair: row[idx("pair")] ?? "",
          chartTF: row[idx("chartTF")] ?? "",
          bestWindowParis: row[idx("bestWindowParis")] ?? "",
          istWindow: row[idx("istWindow")] ?? "",
          golden: toBool(row[idx("golden")]),
          tightRules: row[idx("tightRules")] ?? "",
          comments: row[idx("comments")] ?? "",
          journal: row[idx("journal")] ?? ""
        }));
      }
      CFG.rows = out;
      render();
      setStatus("CSV imported ‚úÖ");
    };
    input.click();
  }

  async function main(){
    // Prefer browser copy (drafts), fallback to repo config
    const fromBrowser = loadFromBrowser();
    CFG = fromBrowser || await loadFromRepo();

    initTheme(CFG.defaultTheme);

    document.getElementById("themeSel").addEventListener("change", (e)=> applyTheme(e.target.value));

    render();

    // delete handlers
    document.getElementById("tbody").addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-del]");
      if(!btn) return;
      const idx = Number(btn.getAttribute("data-del"));
      readTableToCFG();
      CFG.rows.splice(idx, 1);
      render();
    });

    document.getElementById("addRow").addEventListener("click", ()=>{
      readTableToCFG();
      CFG.rows.push(normalizeRow({}));
      render();
      setStatus("Row added ‚ûï");
      // scroll to bottom
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    });

    document.getElementById("saveBrowser").addEventListener("click", ()=>{
      readTableToCFG();
      saveToBrowser();
    });

    document.getElementById("clearBrowser").addEventListener("click", ()=>{
      clearBrowser();
    });

    document.getElementById("exportCfg").addEventListener("click", ()=>{
      readTableToCFG();
      // persist defaultTheme to match current UI selection
      CFG.defaultTheme = document.documentElement.getAttribute("data-theme") || CFG.defaultTheme || "midnight";
      downloadJSON("config.json", CFG);
      setStatus("config.json exported (downloaded) ‚¨áÔ∏è");
    });

    document.getElementById("importCsv").addEventListener("click", importCSV);
  }

  main();
</script>
</body>
</html>
