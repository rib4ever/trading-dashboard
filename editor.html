<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Editor</title>
  <style>
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:#0b0f17;color:#e5e7eb}
    .wrap{max-width:1280px;margin:0 auto;padding:18px}
    h1{margin:0;font-size:18px}
    .muted{color:#9ca3af;font-size:12px;margin-top:6px}
    .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:14px 0}
    .btn{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#e5e7eb;
         padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn:hover{background:rgba(255,255,255,.06)}
    .tableWrap{border:1px solid rgba(255,255,255,.10);border-radius:14px;overflow:auto;background:rgba(255,255,255,.02)}
    table{border-collapse:collapse;width:100%;min-width:1200px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top;font-size:13px}
    th{position:sticky;top:0;background:rgba(17,24,39,.95);backdrop-filter:blur(10px);text-align:left;font-size:12px;color:#cbd5e1}
    input[type="text"], textarea{
      width:100%; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.10);
      border-radius:10px; padding:8px; color:#e5e7eb; outline:none; font-size:13px;
    }
    textarea{min-height:72px; resize:vertical}
    .small{font-size:12px;color:#9ca3af}
    .rowBtn{padding:8px 10px;border-radius:10px}
    .danger{border-color:rgba(239,68,68,.5)}
    .danger:hover{background:rgba(239,68,68,.12)}
    .ok{border-color:rgba(34,197,94,.5)}
    .ok:hover{background:rgba(34,197,94,.12)}
    .note{margin-top:10px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard Editor (Excel-like)</h1>
  <div class="muted">Edit rows here → Save to browser → Dashboard uses it instantly. You can also import CSV from Excel and export config.json.</div>

  <div class="bar">
    <button class="btn ok" id="addRow">+ Add Row</button>
    <button class="btn ok" id="save">Save (Browser)</button>
    <button class="btn" id="exportJson">Export config.json</button>
    <label class="btn">
      Import CSV
      <input id="csvFile" type="file" accept=".csv" style="display:none" />
    </label>
    <button class="btn danger" id="clear">Clear (Browser)</button>
    <a class="btn" href="./index.html" target="_blank">Open Dashboard</a>
  </div>

  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th>Session</th>
          <th>Currency Pair</th>
          <th>Chart time Frame</th>
          <th>Best CTE +1 timeframe (Paris)</th>
          <th>IST time Zone GMT+5:30</th>
          <th>Golden?</th>
          <th>Tight Rules</th>
          <th>Comments</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="note small">
    CSV headers expected:<br>
    <b>session,pair,chartTF,bestWindowParis,istWindow,golden,tightRules,comments</b><br>
    (golden can be TRUE/FALSE or 1/0)
  </div>
</div>

<script>
const KEY = "TRADING_DASH_CFG";

function load(){
  const raw = localStorage.getItem(KEY);
  if(raw){
    try { return JSON.parse(raw); } catch(e){}
  }
  return { rows: [] };
}

function save(cfg){
  localStorage.setItem(KEY, JSON.stringify(cfg, null, 2));
}

function makeRow(){
  return {
    session:"",
    pair:"",
    chartTF:"",
    bestWindowParis:"",
    istWindow:"",
    golden:false,
    tightRules:"",
    comments:""
  };
}

function render(){
  const cfg = load();
  const tb = document.getElementById("tbody");

  tb.innerHTML = cfg.rows.map((r, idx) => `
    <tr>
      <td><input type="text" value="${esc(r.session)}" data-k="session" data-i="${idx}"></td>
      <td><input type="text" value="${esc(r.pair)}" data-k="pair" data-i="${idx}"></td>
      <td><input type="text" value="${esc(r.chartTF)}" data-k="chartTF" data-i="${idx}"></td>
      <td><input type="text" value="${esc(r.bestWindowParis)}" data-k="bestWindowParis" data-i="${idx}"></td>
      <td><input type="text" value="${esc(r.istWindow)}" data-k="istWindow" data-i="${idx}"></td>
      <td style="text-align:center">
        <input type="checkbox" ${r.golden ? "checked":""} data-k="golden" data-i="${idx}">
      </td>
      <td><textarea data-k="tightRules" data-i="${idx}">${esc(r.tightRules)}</textarea></td>
      <td><textarea data-k="comments" data-i="${idx}">${esc(r.comments)}</textarea></td>
      <td><button class="btn rowBtn danger" data-del="${idx}">Delete</button></td>
    </tr>
  `).join("");

  // bind changes
  tb.querySelectorAll("input[type='text'], textarea, input[type='checkbox']").forEach(el=>{
    el.addEventListener("input", ()=>{
      const cfg2 = load();
      const i = +el.getAttribute("data-i");
      const k = el.getAttribute("data-k");
      if(k==="golden") cfg2.rows[i][k] = el.checked;
      else cfg2.rows[i][k] = el.value;
      save(cfg2);
    });
    el.addEventListener("change", ()=>{
      // for checkbox
      const cfg2 = load();
      const i = +el.getAttribute("data-i");
      const k = el.getAttribute("data-k");
      if(k==="golden") cfg2.rows[i][k] = el.checked;
      save(cfg2);
    });
  });

  // delete
  tb.querySelectorAll("[data-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const cfg2 = load();
      const i = +btn.getAttribute("data-del");
      cfg2.rows.splice(i,1);
      save(cfg2);
      render();
    });
  });
}

function esc(s){
  return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}

document.getElementById("addRow").addEventListener("click", ()=>{
  const cfg = load();
  cfg.rows.push(makeRow());
  save(cfg);
  render();
});

document.getElementById("save").addEventListener("click", ()=>{
  // already saved on every edit; this is just a “confirm” button
  alert("Saved in browser. Open/refresh Dashboard to see changes.");
});

document.getElementById("clear").addEventListener("click", ()=>{
  if(confirm("Clear all saved rows from browser?")){
    localStorage.removeItem(KEY);
    render();
  }
});

document.getElementById("exportJson").addEventListener("click", ()=>{
  const cfg = load();
  const blob = new Blob([JSON.stringify(cfg, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "config.json";
  a.click();
  URL.revokeObjectURL(a.href);
});

// ---- CSV import (simple) ----
function parseCSV(text){
  // supports commas; for your Excel you can export CSV UTF-8 (comma). If you export semicolon CSV, tell me and I’ll adapt.
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
  const headers = lines.shift().split(",").map(h=>h.trim());
  const rows = lines.map(line=>{
    // basic CSV split (works if your cells don’t contain commas). If you need quoted CSV support, tell me and I'll upgrade parser.
    const cells = line.split(",").map(c=>c.trim());
    const obj = {};
    headers.forEach((h,i)=> obj[h] = cells[i] ?? "");
    return obj;
  });
  return { headers, rows };
}

function toBool(v){
  const s = String(v ?? "").trim().toLowerCase();
  return (s==="true" || s==="1" || s==="yes" || s==="y");
}

document.getElementById("csvFile").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const text = await f.text();
  const parsed = parseCSV(text);

  const required = ["session","pair","chartTF","bestWindowParis","istWindow","golden","tightRules","comments"];
  const missing = required.filter(r=>!parsed.headers.includes(r));
  if(missing.length){
    alert("CSV missing headers: " + missing.join(", ") + "\n\nExpected:\n" + required.join(","));
    return;
  }

  const cfg = { rows: parsed.rows.map(r=>({
    session: r.session || "",
    pair: r.pair || "",
    chartTF: r.chartTF || "",
    bestWindowParis: r.bestWindowParis || "",
    istWindow: r.istWindow || "",
    golden: toBool(r.golden),
    tightRules: (r.tightRules || "").replaceAll("\\n","\n"),
    comments: (r.comments || "").replaceAll("\\n","\n")
  }))};

  save(cfg);
  render();
  alert("CSV imported into browser memory. Open/refresh Dashboard.");
});

// init
render();
</script>
</body>
</html>
