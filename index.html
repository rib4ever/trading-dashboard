<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trading Sessions Dashboard</title>
  <style>
    :root{
      --bg:#0b0f17;
      --card:#111827;
      --card2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:rgba(255,255,255,.10);
      --accent:#60a5fa;
      --gold:#f59e0b;
      --live:#22c55e;
      --warn:#f97316;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(96,165,250,.18), transparent 50%),
                  radial-gradient(900px 700px at 90% 20%, rgba(245,158,11,.14), transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--accent); text-decoration:none}
    .wrap{max-width:1280px;margin:0 auto;padding:22px}
    .topbar{
      display:flex;justify-content:space-between;align-items:flex-end;gap:16px;flex-wrap:wrap;
      margin-bottom:14px;
    }
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:12px;margin-top:6px}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
    }
    .btn:hover{background:rgba(255,255,255,.06)}
    .grid{display:grid;gap:12px}
    .cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px 14px;
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::after{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(500px 120px at 20% 0%, rgba(96,165,250,.15), transparent 60%);
      pointer-events:none;
    }
    .label{color:var(--muted);font-size:12px}
    .time{font-variant-numeric:tabular-nums;font-size:26px;font-weight:800;margin-top:6px}
    .sub{color:var(--muted);font-size:12px;margin-top:6px}
    .panel{
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .panelTitle{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--live);box-shadow:0 0 0 6px rgba(34,197,94,.12)}
    .panelTitle h2{margin:0;font-size:14px;letter-spacing:.2px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:6px 10px;border-radius:999px;
      font-size:12px; font-weight:700;
      cursor:pointer;
    }
    .chip.active{border-color:rgba(96,165,250,.6); box-shadow:0 0 0 4px rgba(96,165,250,.10)}
    .controls{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      justify-content:space-between;
    }
    .search{
      flex:1;min-width:220px;
      display:flex;gap:10px;align-items:center;
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:14px;padding:10px 12px;
    }
    .search input{
      border:none;outline:none;background:transparent;color:var(--text);width:100%;
      font-size:13px;
    }
    .tableWrap{
      border:1px solid var(--line);
      border-radius:var(--radius);
      overflow:auto;
      background:rgba(255,255,255,.02);
      box-shadow:var(--shadow);
    }
    table{border-collapse:collapse;width:100%;min-width:1100px}
    th,td{padding:12px 12px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top;font-size:13px}
    th{
      position:sticky;top:0;
      background:rgba(17,24,39,.92);
      backdrop-filter: blur(10px);
      text-align:left;
      font-size:12px;
      color:#cbd5e1;
      letter-spacing:.3px;
    }
    tr:hover{background:rgba(255,255,255,.03)}
    tr[data-state="LIVE"]{background:rgba(96,165,250,.10)}
    tr[data-golden="true"] td:nth-child(2){font-weight:900}
    .mono{font-variant-numeric:tabular-nums}
    .small{font-size:12px;color:#cbd5e1}
    .pill{
      display:inline-block;
      padding:5px 10px;border-radius:999px;
      font-size:12px;font-weight:900;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .pill.live{border-color:rgba(34,197,94,.7); box-shadow:0 0 0 4px rgba(34,197,94,.12)}
    .pill.up{border-color:rgba(249,115,22,.7); box-shadow:0 0 0 4px rgba(249,115,22,.10)}
    .pill.end{opacity:.8}
    .goldBadge{
      display:inline-flex;align-items:center;gap:6px;
      padding:5px 10px;border-radius:999px;
      border:1px solid rgba(245,158,11,.55);
      background:rgba(245,158,11,.10);
      font-weight:900;font-size:12px;
    }
    .activeList{
      display:flex;gap:10px;flex-wrap:wrap
    }
    .activeItem{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px 12px;
      min-width:240px;
    }
    .activeItem .t{font-weight:900}
    .activeItem .m{color:var(--muted);font-size:12px;margin-top:4px}
    .footerNote{color:var(--muted);font-size:12px;margin-top:10px}
    @media (max-width: 980px){ .cards{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Trading Sessions Dashboard</h1>
        <div class="subtitle">Live clocks ‚Ä¢ live session windows ‚Ä¢ countdowns (Paris-based) ‚Ä¢ Golden pairs highlighted</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn" href="./editor.html" target="_blank">Open Editor</a>
        <button class="btn" id="reloadBtn">Reload Data</button>
      </div>
    </div>

    <div class="grid">
      <div class="cards" id="clockCards"></div>

      <div class="panel">
        <div class="panelTitle">
          <div class="dot"></div>
          <h2>ACTIVE RIGHT NOW</h2>
        </div>
        <div class="activeList" id="activeNow"></div>
        <div class="footerNote">Tip: Golden pairs will show a üü° and ‚ÄúGOLDEN‚Äù badge.</div>
      </div>

      <div class="panel">
        <div class="controls">
          <div class="search">
            <span style="color:var(--muted)">üîé</span>
            <input id="q" placeholder="Search (pair, session, comments, rules)..." />
          </div>
          <div class="chips" id="chips"></div>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Session</th>
              <th>Currency Pair</th>
              <th>Chart time Frame</th>
              <th>Best CTE +1 timeframe (Paris)</th>
              <th>IST time Zone GMT+5:30</th>
              <th>Status</th>
              <th>Countdown</th>
              <th>Tight Rules</th>
              <th>Comments</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const TZ = { paris:"Europe/Paris", ny:"America/New_York", ist:"Asia/Kolkata" };
let CFG = null;
let FILTER = "ALL"; // ALL | LIVE | UPCOMING | ENDED | GOLDEN
let QUERY = "";

function fmtClock(date, timeZone){
  return new Intl.DateTimeFormat("en-GB",{timeZone,hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false}).format(date);
}
function fmtDate(date, timeZone){
  return new Intl.DateTimeFormat("en-GB",{timeZone,weekday:"short",year:"numeric",month:"short",day:"2-digit"}).format(date);
}
function partsInTZ(date, timeZone){
  const fmt = new Intl.DateTimeFormat("en-GB",{timeZone,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false});
  const parts = fmt.formatToParts(date);
  const get = (t)=> parts.find(p=>p.type===t)?.value;
  return { hh:+get("hour"), mm:+get("minute"), ss:+get("second") };
}
function minutesSinceMidnight(date, timeZone){
  const p = partsInTZ(date, timeZone);
  return p.hh*60 + p.mm + p.ss/60;
}
// "13H30 - 16H00" or "01H00-05H00 / 14H00-18H00"
function parseWindows(str){
  if(!str) return [];
  return str.split("/").map(s=>s.trim()).filter(Boolean).map(seg=>{
    const m = seg.match(/(\d{1,2})\s*[H:]\s*(\d{2})\s*-\s*(\d{1,2})\s*[H:]\s*(\d{2})/i);
    if(!m) return null;
    return { startMin:(+m[1])*60 + (+m[2]), endMin:(+m[3])*60 + (+m[4]) };
  }).filter(Boolean);
}
function toHMS(totalSeconds){
  totalSeconds = Math.max(0, Math.floor(totalSeconds));
  const h = String(Math.floor(totalSeconds/3600)).padStart(2,"0");
  const m = String(Math.floor((totalSeconds%3600)/60)).padStart(2,"0");
  const s = String(totalSeconds%60).padStart(2,"0");
  return `${h}:${m}:${s}`;
}
function stateAndCountdown(now, timeZone, windows){
  if(!windows.length) return { state:"‚Äî", countdown:"‚Äî" };
  const nowMin = minutesSinceMidnight(now, timeZone);

  const inWindow = windows.find(w => nowMin >= w.startMin && nowMin < w.endMin);
  if(inWindow){
    const secs = (inWindow.endMin - nowMin) * 60;
    return { state:"LIVE", countdown:`ends in ${toHMS(secs)}` };
  }

  const future = windows.map(w=>w.startMin).filter(s=>s > nowMin).sort((a,b)=>a-b)[0];
  if(future !== undefined){
    const secs = (future - nowMin) * 60;
    return { state:"UPCOMING", countdown:`starts in ${toHMS(secs)}` };
  }

  const firstTomorrow = windows.map(w=>w.startMin).sort((a,b)=>a-b)[0];
  const minsToMidnight = (24*60) - nowMin;
  const secs = (minsToMidnight + firstTomorrow) * 60;
  return { state:"ENDED", countdown:`next in ${toHMS(secs)}` };
}
function pill(state){
  if(state==="LIVE") return `<span class="pill live">LIVE</span>`;
  if(state==="UPCOMING") return `<span class="pill up">UPCOMING</span>`;
  if(state==="ENDED") return `<span class="pill end">ENDED</span>`;
  return `<span class="pill">${state}</span>`;
}
function renderClocks(now){
  const cards = [
    { title:"Paris Time", tz:TZ.paris },
    { title:"New York Time", tz:TZ.ny },
    { title:"IST Time", tz:TZ.ist }
  ];
  document.getElementById("clockCards").innerHTML = cards.map(c=>`
    <div class="card">
      <div class="label">${c.title}</div>
      <div class="time mono">${fmtClock(now,c.tz)}</div>
      <div class="sub">${fmtDate(now,c.tz)} ‚Ä¢ ${c.tz}</div>
    </div>
  `).join("");
}

function rowMatches(r, info){
  const isGolden = !!r.golden;
  if(FILTER==="LIVE" && info.state!=="LIVE") return false;
  if(FILTER==="UPCOMING" && info.state!=="UPCOMING") return false;
  if(FILTER==="ENDED" && info.state!=="ENDED") return false;
  if(FILTER==="GOLDEN" && !isGolden) return false;

  const hay = [
    r.session, r.pair, r.chartTF, r.bestWindowParis, r.istWindow, r.tightRules, r.comments
  ].join(" ").toLowerCase();

  if(QUERY && !hay.includes(QUERY)) return false;
  return true;
}

function renderActiveNow(now){
  const items = (CFG?.rows || []).map(r=>{
    const windows = parseWindows(r.bestWindowParis || "");
    const info = stateAndCountdown(now, TZ.paris, windows);
    return { r, info };
  }).filter(x=>x.info.state==="LIVE");

  const el = document.getElementById("activeNow");
  if(!items.length){
    el.innerHTML = `<div class="small" style="color:var(--muted)">No active windows right now.</div>`;
    return;
  }

  // Golden first
  items.sort((a,b)=> (b.r.golden===true)-(a.r.golden===true));

  el.innerHTML = items.map(x=>{
    const g = x.r.golden ? `<span class="goldBadge">üü° GOLDEN</span>` : ``;
    return `
      <div class="activeItem">
        <div class="t">${x.r.pair} ${x.r.golden ? "üü°" : ""}</div>
        <div class="m">${x.r.session} ‚Ä¢ ${x.r.bestWindowParis}</div>
        <div class="m"><b>${x.info.countdown}</b> ${g}</div>
      </div>
    `;
  }).join("");
}

function renderRows(now){
  const tbody = document.getElementById("rows");
  const rows = (CFG?.rows || []).map(r=>{
    const windows = parseWindows(r.bestWindowParis || "");
    const info = stateAndCountdown(now, TZ.paris, windows);
    return { r, info };
  }).filter(x=>rowMatches(x.r, x.info));

  tbody.innerHTML = rows.map(x=>{
    const r = x.r, info = x.info, isGolden = !!r.golden;
    return `
      <tr data-state="${info.state}" data-golden="${isGolden}">
        <td>${r.session || ""}</td>
        <td><b>${r.pair || ""}</b> ${isGolden ? " üü°" : ""}</td>
        <td class="mono">${r.chartTF || ""}</td>
        <td class="mono">${r.bestWindowParis || ""}</td>
        <td class="mono">${r.istWindow || ""}</td>
        <td>${pill(info.state)}</td>
        <td class="mono">${info.countdown}</td>
        <td class="small">${(r.tightRules || "").replaceAll("\n","<br>")}</td>
        <td class="small">${(r.comments || "").replaceAll("\n","<br>")}</td>
      </tr>
    `;
  }).join("");
}

async function loadConfig(){
  const ls = localStorage.getItem("TRADING_DASH_CFG");
  if(ls){
    try { return JSON.parse(ls); } catch(e){}
  }
  const res = await fetch("./config.json", { cache:"no-store" });
  return res.json();
}

function renderChips(){
  const defs = [
    ["ALL","All"],["LIVE","Live"],["UPCOMING","Upcoming"],["ENDED","Ended"],["GOLDEN","Golden"]
  ];
  const el = document.getElementById("chips");
  el.innerHTML = defs.map(([k,label])=>`
    <button class="chip ${FILTER===k ? "active":""}" data-k="${k}">${label}</button>
  `).join("");
  el.querySelectorAll("button").forEach(b=>{
    b.addEventListener("click", ()=>{
      FILTER = b.getAttribute("data-k");
      renderChips();
      tick(); // redraw immediately
    });
  });
}

function tick(){
  const now = new Date();
  renderClocks(now);
  renderActiveNow(now);
  renderRows(now);
}

(async function main(){
  CFG = await loadConfig();
  renderChips();

  document.getElementById("q").addEventListener("input",(e)=>{
    QUERY = (e.target.value || "").trim().toLowerCase();
    tick();
  });

  document.getElementById("reloadBtn").addEventListener("click", async ()=>{
    localStorage.removeItem("TRADING_DASH_CFG"); // force load config.json
    CFG = await loadConfig();
    tick();
  });

  tick();
  setInterval(tick, 1000);
})();
</script>
</body>
</html>
